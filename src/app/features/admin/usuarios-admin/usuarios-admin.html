<app-subtitulo-dashboard titulo="Lista de Usuarios Registrados" />

<section class="p-4 flex justify-between">
  <span> Administra todos los Usuarios de manera eficiente</span>
  <button type="button"
    class="bg-amber-800 text-white font-semibold py-2 px-4 rounded-lg hover:bg-amber-700 transition-colors">+ Nuevo
    Usuario</button>
</section>

<section class="mx-4 p-4 border border-gray-300/50 rounded-2xl bg-gray-200/70 dark:bg-white/10 mb-2">
  <div id="" class="grid grid-cols-2 md:grid-cols-4 items-center md:justify-between gap-4 md:gap-0">
    <!--busqueda por username select-->
    <div class="wpDataTableFilterSection" id="table_1_1_filter_sections">
      <label [class]=" searchUsername() && 'px-2 rounded-xl bg-blue-700 text-indigo-50 ring-indigo-200 dark:bg-white dark:text-blue-700'">Usuario :</label>
      <div id="table_1_1_filter" class="column-model">
        <div class="relative bootstrap-select wdt-select-filter wdt-filter-control bs3">
          <select class="pl-6 pr-2 text-blue-700 dark:text-white border-none py-2 bg-blue-100 dark:bg-amber-950"
            title="Username" data-index="1" data-live-search="true" [(ngModel)]="searchUsername"
            data-live-search-placeholder="Search..." tabindex="null">
            <option value="">Selecciona...</option>
            @for (user of currentUsers(); track $index) {
            <option [value]="user.username">{{ user.username}}</option>
            }

          </select>
          <span class="absolute top-2.5 left-1.5 text-blue-600 dark:text-white font-bold"><i
              class="bi bi-search"></i></span>
        </div>
      </div>
    </div>

    <!--busqueda Email input-->
    <div class="relative" id="">
      <label [class]="searchEmail() && 'px-2 rounded-xl bg-blue-700 text-indigo-50 ring-indigo-200 dark:bg-white dark:text-blue-700'">Email :</label>
      <div id="table_1_2_filter" class="column-package">
        <button (click)="activarFiltroEmail()"
          class="dark:bg-amber-800 bg-blue-800 text-white font-semibold py-2 px-4 rounded-lg hover:bg-amber-700 transition-colors"><i
            class="bi bi-funnel"></i> Email</button>
        @if(activeFiltroEmail){
        <div
          class="absolute top-6 flex items-center gap-1 bg-blue-100 text-blue-700 dark:bg-amber-950 dark:text-white  table_1-checkbox-2">
          <i class="bi bi-search ml-2"></i>
          <input type="text" class="p-2 rounded-2xl inline focus:outline-none focus:ring-0 "
            placeholder="Ingresa el correo..." [(ngModel)]="searchEmail">
        </div>
        }
      </div>
    </div>

    <!--toggle checkbox input-->
    <div class="filtro flex flex-col items-start md:items-center gap-0.5 ">
      <label
        class="px-2 rounded-xl has-checked:bg-blue-700 has-checked:text-indigo-50 has-checked:ring-indigo-200 dark:has-checked:bg-white dark:has-checked:text-blue-700 dark:has-checked:ring-indigo-900 ...">
        <i class="bi bi-person-rolodex"></i>
        Rol:
        <input type="checkbox" [(ngModel)]="activeFiltroRol" class="checked:border-indigo-500 ..."  />
      </label>

      <input type="checkbox" id="checkbox" [disabled]="!activeFiltroRol()" class="sr-only peer disabled:bg-gray-100/50"
        (change)="cambiarFiltroRol()" />
      <label for="checkbox"
        [class]="'relative flex items-center w-20 h-8  rounded-full cursor-pointer  transition-colors duration-300 ' + (!activeFiltroRol() ? 'bg-gray-300 dark:bg-gray-500' : 'bg-blue-600 peer-checked:bg-green-500')">
        <!-- Texto ON/OFF -->
        <span
          [class]="'absolute left-1 text-xs font-semibold text-gray-600  peer-checked:text-white transition-all duration-300 '+ (checkedRol() ? 'text-white':'text-transparent')">Usuario</span>
        <span
          [class]="'absolute right-1 text-xs font-semibold  transition-all duration-300 '+ (!checkedRol() ? 'text-white':'text-transparent')">Admin</span>

        <!-- Ãcono opcional -->
        <span
          [class]="'absolute left-0 top-0 w-8 h-8 bg-white dark:bg-gray-200 rounded-full shadow-md transform transition-transform duration-300 ease-in-out '+ ( checkedRol() && 'translate-x-12')">
        </span>
      </label>
    </div>

    <!--Resetear los filtros-->
    <div class="flex md:justify-center" >
      <button class="bg-green-800 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors"
        aria-label="Clear filters" role="button" (click)="resetFiltros()">Limpiar filtros</button>
    </div>
  </div>
</section>

<busqueda-input (enviarResultado)="recibirNombre($event)" />

<div class="flex flex-col items-center justify-center">
  @if (userService.errorMessage()) {
  <p class="error">{{userService.errorMessage()}}</p>
  }
  @if (userService.isLoading()) {
  <app-spiner-cargando mensaje="Cargando Usuarios" [isColor]="true" />
  }

</div>

@if (userService.usuarios().length > 0) {
<div class="relative w-full md:px-4 overflow-x-auto shadow-md sm:rounded-lg">
  <table class="min-w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
    <thead class="text-xs text-gray-700 uppercase bg-blue-100 dark:bg-gray-700 dark:text-gray-400">
      <tr>
        <th scope="col" class="px-1 py-3">
          Nombre
        </th>
        <th scope="col" class="px-1 py-3">
          UserName
        </th>
        <th scope="col" class="px-1 py-3">
          Email
        </th>
        <th scope="col" class="px-1 py-3">
          Celular
        </th>
        <th scope="col" class="px-1 py-3">
          Rol
        </th>
        <th scope="col" class="px-1 py-3">
          Acciones
        </th>
      </tr>
    </thead>
    <tbody>
      @for (usuario of listaFiltrada(); track $index) {
      @if (usuario.username !== authService.currentUserAuth$()?.username) {
      <tr
        class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 border-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600" animate.enter="fade-in" animate.leave="fade-out" >
        <th scope="row" class="px-1 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
          {{usuario.nombreCompleto}}
        </th>
        <td class="px-1 py-4">
          {{usuario.username}}
        </td>
        <td class="px-1 py-4">
          {{usuario.email}}
        </td>
        <td class="px-1 py-4">
          {{usuario.celular}}
        </td>
        <td class="px-1 py-4">
          {{usuario.rol}}
        </td>
        <td class="px-1 py-4 text-center flex gap-1 items-center">
          <button class="bg-gray-500 text-white p-1 rounded-md text-xs hover:bg-yellow-600 transition-colors mr-1"
            (click)="editarMensaje(usuario)">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15.232 5.232l3.536 3.536M9 13.5l-6 6V21h6l6-6-3.536-3.536z" />
            </svg>
          </button>
          <button class="bg-red-500 text-white p-1 rounded-md text-xs hover:bg-red-600 transition-colors"
            (click)="eliminarMensaje(usuario.id!)">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </td>
      </tr>
      }
      }

      @if(listaFiltrada().length===0){
      <tr>
        <td colspan="6" class="border px-4 py-4 text-center">No se encontraron resultados con esos filtros.</td>
      </tr>
      }


    </tbody>
  </table>
</div>

}
